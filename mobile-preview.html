<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]>
<html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>
<html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>
<html class="no-js lt-ie9" lang="en"> <![endif]-->
<!-- Consider adding a manifest.appcache: h5bp.com/d/Offline -->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en"> <!--<![endif]-->
<head>
    <base href="src/">
    <meta charset="utf-8">

    <!-- Use the .htaccess and remove these lines to avoid edge case issues.
 More info: h5bp.com/i/378 -->
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <title>Mobile Preview</title>
    <meta name="description" content="">

    <!-- Mobile viewport optimized: h5bp.com/viewport -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no, target-densitydpi=device-dpi">

    <!-- Place favicon.ico and apple-touch-icon.png in the root directory: mathiasbynens.be/notes/touch-icons -->
    <link rel="stylesheet" href="css/store.css">

    <!-- More ideas for your <head> here: h5bp.com/d/head-Tips -->


</head>
<body>
<!-- Prompt IE 6 users to install Chrome Frame. Remove this if you support IE 6.
chromium.org/developers/how-tos/chrome-frame-getting-started -->
<!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a
    different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a>
    to experience this site.</p><![endif]-->


<div role="main" id="main">
</div>

<div id="preroll-cover"></div>

<!-- JavaScript at the bottom for fast page loading -->
<script src="js/libs/jquery/jquery-1.9.1.min.js"></script>

<!-- jQuery plugins -->

<!-- scripts concatenated and minified via build script -->
<script>

    var isMobile = {
        Android: function() {
            return navigator.userAgent.match(/Android/i) ? true : false;
        },
        BlackBerry: function() {
            return navigator.userAgent.match(/BlackBerry/i) ? true : false;
        },
        iOS: function() {
            return navigator.userAgent.match(/iPhone|iPad|iPod/i) ? true : false;
        },
        Windows: function() {
            return navigator.userAgent.match(/IEMobile/i) ? true : false;
        },
        any: function() {
            return (isMobile.Android() || isMobile.BlackBerry() || isMobile.iOS() || isMobile.Windows());
        }
    };

    // Stub native API calls so that they won't block execution \ prevent higher level DOM event handlers from running
    window.SoomlaNative = {
        playPop : function() {},
        storeInitialized : function() {
            require(["native-api-stubs"], function(NativeApiStubs) {
                // Inject Native API stubs
                _.extend(SoomlaJS.storeView, NativeApiStubs);
            });
        }
    };


    $(window).load(function() {

        // Get the "?theme=XXX" value from the URL to determine which JSON to load
        // Fallback to the default theme.json
        var getParameterByName = function(name) {
            name = name.replace(/[\[]/, "\\\[").replace(/[\]]/, "\\\]");
            var regexS = "[\\?&]" + name + "=([^&#]*)";
            var regex = new RegExp(regexS);
            var results = regex.exec(window.location.search);
            if(results == null)
                return "";
            else
                return decodeURIComponent(results[1].replace(/\+/g, " "));
        };

        var themesFolder 	= "../../storefront-themes/themes",
			themeName 		= getParameterByName("theme"),
            themePath       = themesFolder + "/" + themeName +  "/theme",
            modelUrl 		= themesFolder + "/" + themeName +  "/theme/" + themeName + ".json",
			themeUrl 		= themesFolder + "/" + themeName +  "/theme.json",
            modelAjax       = $.ajax({url : modelUrl, dataType : "json"}),
            themeAjax       = $.ajax({url : themeUrl, dataType : "json"});


        var updateJsonPaths = function(json) {
            _.each(json, function(value, key) {
                if (_.isObject(value)) {
                    // Recursive call
                    updateJsonPaths(value);
                } else if (_.isString(value)) {
                    // Replace the path
                    json[key] = themePath + "/" + value;
                }
            });
        };

        var augmentImagePath = function(templateObj, themeObj) {
            _.each(templateObj, function(templateValue, templateKey) {

                var themeValue = themeObj[templateKey];
                if (_.isObject(templateValue)) {
                    switch (templateValue.type) {
                        case "image":
                            themeObj[templateKey] = themePath + "/" + themeValue;
                            break;
                        case "backgroundImage":
                            themeObj[templateKey] = themePath + "/" + themeValue;
                            break;
                        case "font":
                            themeObj[templateKey].url = themePath + "/" + themeValue.url;
                            break;
                        case "css":
                            break;
                        default:
                            augmentImagePath(templateValue, themeValue);
                    }
                }
            });

        };


        // Request both JSONs
        $.when(modelAjax, themeAjax).done(function(modelData, themeData) {

            var model 			= modelData[0],
                theme 			= themeData[0],
            	templateUrl     = "../../storefront-themes/templates/" + theme.template.name + "/template.json",
                templateAjax    = $.ajax({url : templateUrl, dataType : "json"});


            $.when(templateAjax).done(function(template) {

                // Replace paths with
                augmentImagePath(template.attributes, theme.theme);
                updateJsonPaths(theme.modelAssets);

                // Inject the base URL for loading template
                theme.template.baseUrl = "/storefront-themes/templates/" + theme.template.name;

                // Prevent storefront from augmenting image paths, since this page already does it
                theme.imagePathsAugmented = true;

                var data = _.extend({}, model, theme);

                // Initialize store
                SoomlaJS.initialize(data);

                // Inject prices and balances
                var goods = {};
                _.each(data.categories, function(category) {
                    _.each(category.goods, function(good) {
                        goods[good.itemId] = {
                            balance : 0,
                            price : good.priceModel.values
                        };
                    });
                });
                SoomlaJS.goodsUpdated(goods);

            });

        }).fail(function(modelData, themeData) {
            console.log("Error: Couldn't retrieve either the model JSON or the theme JSON.");
        });

    });
</script>
<script data-main="js/main" src="js/libs/require.js"></script>
<!-- end scripts -->

</body>
</html>